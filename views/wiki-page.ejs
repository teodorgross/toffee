<%
const currentPage = 'wiki';
const title = page.title;
%>

<!-- Breadcrumb Navigation -->
<section class="wiki-breadcrumb">

    <nav class="wiki-breadcrumb-nav">
        <a href="/wiki" class="wiki-breadcrumb-link">
            <i class="fas fa-home"></i> Wiki
        </a>
        <% if (page.breadcrumb && page.breadcrumb.length > 0) { %>
            <% page.breadcrumb.forEach((crumb, index) => { %>
                <span class="wiki-breadcrumb-separator">/</span>
                <% if (index === page.breadcrumb.length - 1) { %>
                    <span class="wiki-breadcrumb-current"><%= crumb.title %></span>
                <% } else { %>
                    <a href="/wiki/<%= crumb.path %>" class="wiki-breadcrumb-link">
                        <%= crumb.title %>
                    </a>
                <% } %>
            <% }) %>
        <% } %>
    </nav>
</section>

<!-- Page Content -->
<section class="content-section animate-fade-in">
    <div class="wiki-page-layout">
        <!-- Main Content -->
        <div class="wiki-main-content">
            <article class="wiki-article">
                <header class="wiki-page-header">
                    <h1 class="wiki-page-title"><%= page.title %></h1>
                    
                    <div class="wiki-page-meta">
                        <div class="wiki-meta-item">
                            <i class="fas fa-folder"></i>
                            <span class="wiki-category-badge"><%= page.category %></span>
                        </div>
                        <div class="wiki-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>Updated <%= moment(page.lastModified).format('MMMM DD, YYYY') %></span>
                        </div>
                        <% if (page.tags.length > 0) { %>
                            <div class="wiki-meta-item">
                                <i class="fas fa-tags"></i>
                                <div class="wiki-page-tags">
                                    <% page.tags.forEach(tag => { %>
                                        <a href="/wiki/search?q=<%= tag %>" class="wiki-tag">#<%= tag %></a>
                                    <% }) %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </header>

                <div class="wiki-page-content">
                    <%- page.content %>
                </div>

                <footer class="wiki-page-footer">
                    <div class="wiki-page-actions">
                        <a href="/wiki" class="btn-terminal">
                            <i class="fas fa-arrow-left"></i> Back to Wiki
                        </a>
                        <div class="wiki-page-info">
                            <span class="wiki-file-info">
                                <i class="fas fa-file-code"></i>
                                <%= page.slug %>.md
                            </span>
                        </div>
                    </div>
                </footer>
            </article>
        </div>

        <!-- Sidebar -->
        <aside class="wiki-sidebar">
            <!-- Table of Contents -->
            <div class="wiki-sidebar-section">
                <h3 class="wiki-sidebar-title">
                    <i class="fas fa-list"></i> Table of Contents
                </h3>
                <div class="wiki-toc" id="wiki-toc">
                    <!-- Generated by JavaScript -->
                </div>
            </div>

            <!-- Related Pages -->
            <% if (relatedPages.length > 0) { %>
                <div class="wiki-sidebar-section">
                    <h3 class="wiki-sidebar-title">
                        <i class="fas fa-link"></i> Related Pages
                    </h3>
                    <div class="wiki-related-pages">
                        <% relatedPages.forEach(relatedPage => { %>
                            <div class="wiki-related-item">
                                <a href="/wiki/<%= relatedPage.slug %>" class="wiki-related-link">
                                    <i class="fas fa-file-alt"></i>
                                    <%= relatedPage.title %>
                                </a>
                                <div class="wiki-related-meta">
                                    <%= moment(relatedPage.lastModified).fromNow() %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            <% } %>


            <!-- Quick Stats -->
            <div class="wiki-sidebar-section">
                <h3 class="wiki-sidebar-title">
                    <i class="fas fa-info-circle"></i> Page Info
                </h3>
                <div class="wiki-page-stats">
                    <div class="wiki-stat-item">
                        <span class="wiki-stat-label">Category:</span>
                        <span class="wiki-stat-value"><%= page.category %></span>
                    </div>
                    <div class="wiki-stat-item">
                        <span class="wiki-stat-label">Last Modified:</span>
                        <span class="wiki-stat-value"><%= moment(page.lastModified).fromNow() %></span>
                    </div>
                    <div class="wiki-stat-item">
                        <span class="wiki-stat-label">Word Count:</span>
                        <span class="wiki-stat-value"><%= page.rawContent.split(' ').length %></span>
                    </div>
                    <div class="wiki-stat-item">
                        <span class="wiki-stat-label">Reading Time:</span>
                        <span class="wiki-stat-value"><%= Math.ceil(page.rawContent.split(' ').length / 200) %> min</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</section>

<script>
// Generate Table of Contents
document.addEventListener('DOMContentLoaded', function() {
    const content = document.querySelector('.wiki-page-content');
    const toc = document.getElementById('wiki-toc');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    if (headings.length === 0) {
        toc.innerHTML = '<div class="wiki-toc-empty">No headings found</div>';
        return;
    }
    
    const tocList = document.createElement('ul');
    tocList.className = 'wiki-toc-list';
    
    headings.forEach((heading, index) => {
        // Create unique ID for heading
        const id = `heading-${index}`;
        heading.id = id;
        
        // Create TOC item
        const tocItem = document.createElement('li');
        tocItem.className = `wiki-toc-item wiki-toc-${heading.tagName.toLowerCase()}`;
        
        const tocLink = document.createElement('a');
        tocLink.href = `#${id}`;
        tocLink.textContent = heading.textContent;
        tocLink.className = 'wiki-toc-link';
        
        // Smooth scroll
        tocLink.addEventListener('click', function(e) {
            e.preventDefault();
            heading.scrollIntoView({ behavior: 'smooth' });
        });
        
        tocItem.appendChild(tocLink);
        tocList.appendChild(tocItem);
    });
    
    toc.appendChild(tocList);
    
    // Highlight current section while scrolling
    window.addEventListener('scroll', function() {
        let current = '';
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100) {
                current = heading.id;
            }
        });
        
        document.querySelectorAll('.wiki-toc-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${current}`) {
                link.classList.add('active');
            }
        });
    });
});
</script>